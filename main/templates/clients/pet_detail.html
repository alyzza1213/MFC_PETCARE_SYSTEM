{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ pet.name }} - Profile</title>
<style>
/* --- Profile Container --- */
.profile-container {
    width: 400px;
    margin: 30px auto;
    background: #fff;
    padding: 25px 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    text-align: center;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.profile-container img {
    width: 180px;
    height: 180px;
    border-radius: 12px;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s ease;
}
.profile-container img:hover {
    transform: scale(1.05);
}
.profile-container h2 {
    margin: 12px 0;
    color: #333;
}
.profile-container p {
    margin: 6px 0;
    color: #555;
    font-size: 14px;
}
input[type="file"] {
    display: none;
}
input[type="number"] {
    width: 100px;
    padding: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 5px;
}
.btn-update {
    display: inline-block;
    margin-top: 10px;
    padding: 8px 15px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s ease;
}
.btn-update:hover {
    background-color: #0056b3;
}
.notice {
    font-size: 13px;
    color: #888;
    margin-top: 10px;
}

/* --- Vaccine Records Grid --- */
.vaccine-section {
    width: 90%;
    margin: 30px auto;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.vaccine-section h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}
.vaccine-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.vaccine-grid .grid-header,
.vaccine-grid .grid-row {
    display: grid;
    grid-template-columns: 1fr 1fr 2fr 2fr 2fr 2fr; 
    gap: 8px;
    padding: 8px 10px;
    align-items: center;
}
.grid-header {
    font-weight: 700;
    background: #00695c;
    color: white;
    border-radius: 8px;
}
.grid-row {
    background: #f8f9fa;
    border-radius: 8px;
}
.grid-row:nth-child(even) {
    background: #e0f2f1;
}
.grid-row input[type="text"],
.grid-row input[type="date"] {
    width: 100%;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}
.grid-row .btn-update {
    padding: 6px 10px;
    font-size: 13px;
}

/* Add new vaccine form */
.add-vaccine-form {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.add-vaccine-form input[type="text"],
.add-vaccine-form input[type="date"] {
    flex: 1 1 150px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
.add-vaccine-form button {
    padding: 6px 12px;
    border-radius: 6px;
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    transition: background 0.2s ease;
}
.add-vaccine-form button:hover {
    background-color: #218838;
}

/* Responsive */
@media (max-width: 768px) {
    .vaccine-grid .grid-header,
    .vaccine-grid .grid-row {
        grid-template-columns: 1fr 1fr; 
        row-gap: 6px;
    }
    .add-vaccine-form {
        flex-direction: column;
    }
}

</style>
</head>
<body>

<div class="profile-container">
  <h2>{{ pet.name }}</h2>
  
  {% if not user.is_staff %}
  <label for="petImageInput">
    {% if pet.image %}
      <img id="petImage" src="{{ pet.image.url }}" alt="{{ pet.name }}">
    {% else %}
      <img id="petImage" src="{% static 'images/default_pet.png' %}" alt="{{ pet.name }}">
    {% endif %}
  </label>
  <input type="file" id="petImageInput" accept="image/*">
  {% else %}
    {% if pet.image %}
      <img src="{{ pet.image.url }}" alt="{{ pet.name }}">
    {% else %}
      <img src="{% static 'images/default_pet.png' %}" alt="{{ pet.name }}">
    {% endif %}
    <div class="notice">Admin cannot change user-uploaded image</div>
  {% endif %}

  <p><strong>Species:</strong> {{ pet.species }}</p>
  <p><strong>Breed:</strong> {{ pet.breed }}</p>
  <p><strong>Gender:</strong> {{ pet.gender }}</p>
  <p><strong>Birthday:</strong> {{ pet.birthday }}</p>
  <p><strong>Weight (kg):</strong> 
    {% if user.is_staff %}
      <form method="POST" action="{% url 'add_or_edit_pet_admin' pet.id %}" style="display:inline;">
        {% csrf_token %}
        <input type="number" step="0.01" name="weight" value="{{ pet.weight|default:'' }}">
        <button type="submit" class="btn-update">Update</button>
      </form>
    {% else %}
      {{ pet.weight|default:"Not set" }}
    {% endif %}
  </p>

  <p><strong>Owner Contact:</strong> {{ pet.owner.ownerprofile.contact }}</p>
  <p><strong>Address:</strong> {{ pet.owner.ownerprofile.address }}</p>
</div>

<!-- Vaccine Records Section -->
<div class="vaccine-section">
  <h2>ðŸ’‰ Vaccine Records</h2>
  <div class="vaccine-grid">
    <div class="grid-header">
      <div>Date Given</div>
      <div>Next Vaccination</div>
      <div>Vaccine</div>
      <div>Manufacturer</div>
      <div>Veterinarian</div>
      {% if user.is_staff %}<div>Action</div>{% endif %}
    </div>

    {% for vaccine in pet.vaccinerecord_set.all %}
    <div class="grid-row">
      {% if user.is_staff %}
      <form method="POST" action="{% url 'edit_vaccine' vaccine.id %}">
        {% csrf_token %}
        <input type="date" name="date_given" value="{{ vaccine.date_given|date:'Y-m-d' }}">
        <input type="date" name="next_due_date" value="{{ vaccine.next_due_date|date:'Y-m-d' }}">
        <input type="text" name="vaccine_name" value="{{ vaccine.vaccine_name }}">
        <input type="text" name="manufacturer" value="{{ vaccine.manufacturer }}">
        <input type="text" name="veterinarian" value="{{ vaccine.veterinarian }}">
        <button type="submit" class="btn-update">Update</button>
      </form>
      {% else %}
        <div>{{ vaccine.date_given|date:'M d, Y' }}</div>
        <div>{{ vaccine.next_due_date|date:'M d, Y' }}</div>
        <div>{{ vaccine.vaccine_name }}</div>
        <div>{{ vaccine.manufacturer }}</div>
        <div>{{ vaccine.veterinarian }}</div>
      {% endif %}
    </div>
    {% empty %}
      <p style="text-align:center; color:#888;">No vaccine records found.</p>
    {% endfor %}
  </div>

  {% if user.is_staff %}
  <div class="add-vaccine-form">
    <form method="POST" action="{% url 'add_vaccine' %}">
      {% csrf_token %}
      <input type="hidden" name="pet_id" value="{{ pet.id }}">
      <input type="date" name="date_given" required>
      <input type="date" name="next_due_date" required>
      <input type="text" name="vaccine_name" placeholder="Vaccine Name" required>
      <input type="text" name="manufacturer" placeholder="Manufacturer" required>
      <input type="text" name="veterinarian" placeholder="Veterinarian" required>
      <button type="submit">Add Vaccine</button>
    </form>
  </div>
  {% endif %}
</div>

{% if not user.is_staff %}
<script>
document.getElementById("petImageInput").addEventListener("change", function(){
    const file = this.files[0];
    if (file){
        const reader = new FileReader();
        reader.onload = function(e){
            document.getElementById("petImage").src = e.target.result;
        }
        reader.readAsDataURL(file);

        // Auto upload image to server
        const formData = new FormData();
        formData.append("image", file);
        fetch("{% url 'update_pet_image' pet.id %}", {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            body: formData
        }).then(res => res.json())
          .then(data => {
            if(data.status === 'success') console.log("Image updated!");
            else alert("Failed to update image.");
        });
    }
});
</script>
{% endif %}

</body>
</html>
